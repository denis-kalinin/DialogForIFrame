<!DOCTYPE html>
<html class="no-js">
    <head>
        <meta charset="utf-8">
        <title>AL main pane</title>
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <base href="<%= webcontext %>" />
        <script>
            function onPageLoaded(){
                window.self.addEventListener('dialog-loaded', function(){
                    console.info('[WATIR]: Dialog loaded (opener)');
                });
            }
        </script>
        <script type="text/javascript">
            function getTopWindow(checkWindow){
                if(!checkWindow) checkWindow = window.self;
                try {
                    if(checkWindow.parent && !checkWindow.parent.noDialog){
                        return getTopWindow(checkWindow.parent);
                    }
                } catch (e) {}
                return checkWindow;
            }
            function showDialog(windowName){
                var targetWindow = getTopWindow();
                if(!targetWindow.dialogPolyfill){
                    var script = targetWindow.document.createElement("script");
                    script.setAttribute("src", "topdialog.js");
                    script.addEventListener("load", function(evt){
                        targetWindow.postMessage({
                            dialog:{
                                name:'a18',
                                windowName: windowName,
                                ignoreOnLoad: true
                            }}, '*');
                    });
                    targetWindow.document.head.appendChild(script);
                } else {
                    targetWindow.postMessage({
                        dialog:{
                            name:'a18',
                            windowName: windowName,
                            ignoreOnLoad: true
                        }}, '*');
                }                
            }

            function openDialog(url){
                var targetWindow = getTopWindow();
                if(!targetWindow.dialogPolyfill){
                    var script = targetWindow.document.createElement("script");
                    script.setAttribute("src", "topdialog.js");
                    script.addEventListener("load", function(evt){
                        targetWindow.postMessage({
                            dialog:{
                                url: url,
                                name:'a18',
                                windowName: 'a18_'+new Date().getTime()
                            }}, '*');
                    });
                    targetWindow.document.head.appendChild(script);
                } else {
                    targetWindow.postMessage({
                        dialog:{
                            url:url,
                            name:'a18',
                            windowName: 'a18_'+new Date().getTime()
                        }}, '*');
                }                
            }

            function openDialogListener(elem, evt) {
                var targetWindow = getTopWindow();
                if(!targetWindow.dialogPolyfill){
                    var script = targetWindow.document.createElement("script");
                    script.setAttribute("src", "topdialog.js");
                    script.addEventListener("load", function(evt){
                        targetWindow.postMessage({
                            dialog:{
                                url: elem.dataset.topdialogUrl,
                                size:{
                                    width: elem.dataset.topdialogWidth,
                                    height: elem.dataset.topdialogHeight
                                },
                                name:'a18',
                                windowName: 'a18_'+new Date().getTime()
                            }}, '*');
                    });
                    targetWindow.document.head.appendChild(script);
                } else {
                    targetWindow.postMessage({
                        dialog:{
                            url:elem.dataset.topdialogUrl,
                            size:{
                                width: elem.dataset.topdialogWidth,
                                height: elem.dataset.topdialogHeight
                            },
                            name:'a18',
                            windowName: 'a18_'+new Date().getTime()
                        }}, '*');
                }
            }
            function postToDialog(){
                var postWindow = 'a18_asdf4';
                var form = document.createElement("FORM");
                form.method = "post";
                form.action = '/post';
                form.target = postWindow;
                form.style.position = "absolute";
                form.style.top = 0;
                form.style.visibility = "hidden";
                document.body.appendChild(form);
                var textarea = document.createElement("TEXTAREA");
                textarea.name = 'dta';
                textarea.value = 'Hello world! (POSTED)';
                form.appendChild(textarea);
                window.addEventListener('message', function(){
                    form.submit();
                }, { once: true });
                showDialog(postWindow);                
            }
            function proceedMime(url, param, mime){
                var mimeCheck = function (type) {
                    return Array.prototype.reduce.call(navigator.plugins, function (supported, plugin) {
                        return supported || Array.prototype.reduce.call(plugin, function (supported, mime) {
                            console.debug('browser plugin mime:', mime.type);
                            return supported || mime.type == type;
                        }, supported);
                    }, false);
                };
                if(mimeCheck(mime)){
                    console.info('MIME', mime, 'supported!');
                    openDialog(url+'?inline='+param);
                } else {
                    //openDialog(url);
                    var difr = document.createElement('iframe');
                    difr.style.display='none';
                    difr.src=url+'?inline='+param;
                    difr.addEventListener('load', function(){
                        try{
                            console.info('Loaded document: ', difr.contentWindow.location);
                            difr.style.display='block';
                        }catch(e) {
                            //cross-oring error if plugins
                            difr.style.display='block';
                        }
                    });
                    try{
                        document.body.appendChild(difr);
                    } catch(e){
                        console.error(e);
                    }
                }
            }
            function showDocument(url, config){
                var targetWindow = getTopWindow();
                var title = (config && congig.title) ? config.title : 'Document';
                var mime = (config && config.mime) ? config.mime : null;
                if(!targetWindow.dialogPolyfill){
                    var script = targetWindow.document.createElement("script");
                    script.setAttribute("src", "topdialog.js");
                    script.addEventListener("load", function(evt){
                        targetWindow.postMessage({
                            downloader:{
                                url: url,
                                title: title,
                                mime: mime,
                                name:'docView',
                                windowName: 'docView_'+ new Date().getTime()
                            }}, '*');
                    });
                    targetWindow.document.head.appendChild(script);
                } else {
                    targetWindow.postMessage({
                        downloader:{
                            url:url,
                            title: title,
                            mime: mime,
                            name:'docView',
                            windowName: 'docView_'+ new Date().getTime()
                        }}, '*');
                }
            }

            function showHTML(config){
                var targetWindow = getTopWindow();
                if(!targetWindow.dialogPolyfill){
                    var script = targetWindow.document.createElement("script");
                    script.setAttribute("src", "topdialog.js");
                    script.addEventListener("load", function(evt){
                        targetWindow.postMessage({dialog: config}, '*');
                    });
                    targetWindow.document.head.appendChild(script);
                } else {
                    targetWindow.postMessage({dialog:config}, '*');
                }                
            }
        </script>
    </head>
    <body onload="onPageLoaded()">
        <h1>TABLE</h1>
        <p>To open a dialog, make sure that <code>dialogPolyfill</code> is installed in <code>window.top</code>
            and send message to <code>window.top</code> with JavaScript:
        </p>
        <p>A triggering element (e.g. <code>&lt;button /&gt;</code>) SHOULD have <code>data-topdialog-url</code> attribute:</p>
        <code>&lt;button id="button1" data-topdialog-url="static/html/wizard.html"&gt;SHOW DIALOG&lt;/button&gt;</code>
        <p>And iframe has the script to handle <code>onclick</code>:</p>
        <hr />
        <button id="button1" data-topdialog-url="static/html/wizard.html" data-topdialog-width="100%" data-topdialog-height="350px" onclick="openDialogListener(this);">SHOW DIALOG</button>
        <button id="button2" data-topdialog-url="https://bing.com" onclick="openDialogListener(this);">Bing</button>
        <button id="button3" data-topdialog-url="static/html/wizard.html" data-topdialog-width="0" data-topdialog-height="0" onclick="openDialogListener(this);">0 size</button>
        <button id="button3" data-topdialog-url="static/html/wizard.html" data-topdialog-width="300" data-topdialog-height="0" onclick="openDialogListener(this);">wrong size</button>
        <button id="button4" data-topdialog-url="static/html/redirect.html" onclick="openDialogListener(this);">Redirect</button>
        <hr />
        <button id="button5" onclick="postToDialog();">POST TO DIALOG</button>
        <hr />
        <button id="button6" data-topdialog-url="static/html/download.html" onclick="openDialogListener(this);">Download</button>
        <button id="button7" onclick="proceedMime('/data', 'pdf', 'application/pdf')">PDF</button>
        <button id="button8" onclick="proceedMime('/data', 'docx', 'application/vnd.openxmlformats-officedocument.wordprocessingml.document');">DOCX</button>
        <hr />
        <button id="button9" onclick="showDocument('/data?inline=pdf', null);">View PDF</button>
        <button id="button10" onclick="showDocument('/data?inline=docx');">View DOCX</button>
        <button id="button11" onclick="showDocument('/data?format=docx');">Download DOCX</button>
        <hr />
        <button id="button12" onclick="showHTML({html:'<html><body><strong>Hello</strong> world!</body></html>', title:'Message', size: {width:'null', height:'8em'}});">Write HTML</button>
        <button id="button13" data-topdialog-url="static/html/iframed.html" data-topdialog-width="100%" data-topdialog-height="350px" onclick="openDialogListener(this);">IFRAMED DIALOG</button>
        <hr />
        <button id="button14" data-topdialog-url="static/html/editor/htmleditor.html" data-topdialog-width="100%" data-topdialog-height="350px" onclick="openDialogListener(this);">HTML editor</button>
        <table>
            <tr>
                <td>1124</td>
                <td>gaoiewfabao</td>
            </tr>
            <tr>
                <td>1124</td>
                <td>gaoiewfabao</td>
            </tr>            <tr>
                <td>1124</td>
                <td>gaoiewfabao</td>
            </tr>            <tr>
                <td>1124</td>
                <td>gaoiewfabao</td>
            </tr>            <tr>
                <td>1124</td>
                <td>gaoiewfabao</td>
            </tr>            <tr>
                <td>1124</td>
                <td>gaoiewfabao</td>
            </tr>            <tr>
                <td>1124</td>
                <td>gaoiewfabao</td>
            </tr>            <tr>
                <td>1124</td>
                <td>gaoiewfabao</td>
            </tr>            <tr>
                <td>1124</td>
                <td>gaoiewfabao</td>
            </tr>            <tr>
                <td>1124</td>
                <td>gaoiewfabao</td>
            </tr>            <tr>
                <td>1124</td>
                <td>gaoiewfabao</td>
            </tr>            <tr>
                <td>1124</td>
                <td>gaoiewfabao</td>
            </tr>            <tr>
                <td>1124</td>
                <td>gaoiewfabao</td>
            </tr>            <tr>
                <td>1124</td>
                <td>gaoiewfabao</td>
            </tr>            <tr>
                <td>1124</td>
                <td>gaoiewfabao</td>
            </tr>            <tr>
                <td>1124</td>
                <td>gaoiewfabao</td>
            </tr>            <tr>
                <td>1124</td>
                <td>gaoiewfabao</td>
            </tr>            <tr>
                <td>1124</td>
                <td>gaoiewfabao</td>
            </tr>            <tr>
                <td>1124</td>
                <td>gaoiewfabao</td>
            </tr>
        </table>
    </body>
</html>